name: Deploy React App to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to AWS Server
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Copy all files to server
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r * ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/ubuntu/react-website/
        
        # Build and run Docker container on server
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd /home/ubuntu/react-website
          
          # Stop old container
          docker stop react-app-container 2>/dev/null || true
          docker rm react-app-container 2>/dev/null || true
          
          # Remove old image to save space
          docker rmi react-app:latest 2>/dev/null || true
          
          # Build new image (this runs npm install and npm build inside Docker)
          docker build -t react-app:latest .
          
          # Run new container
          docker run -d --name react-app-container -p 80:80 react-app:latest
          
          echo "âœ… React app deployed!"
          docker ps
        EOF
      env:
        SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
